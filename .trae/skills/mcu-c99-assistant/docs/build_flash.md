# 构建与烧录

## 构建系统

### 构建系统规范

#### Makefile配置规范

- **平台支持**：支持多平台编译，通过变量控制不同平台的编译选项
- **编译器配置**：根据平台选择合适的编译器和编译选项
- **优化级别**：根据需要设置-O0到-O3的优化级别
- **调试信息**：添加-g选项生成调试信息
- **依赖管理**：自动处理文件依赖关系
- **目标文件**：生成多种格式的目标文件（elf、hex、bin）
- **烧录规则**：添加烧录和调试规则

#### 多平台支持规范

- **平台定义**：明确支持的平台列表
- **条件编译**：使用条件编译处理不同平台的差异
- **链接脚本**：为不同平台提供合适的链接脚本
- **编译选项**：为不同平台设置合适的编译选项

## 编译选项

### 优化级别

- **-O0**：无优化，编译速度快，调试信息完整
- **-O1**：基本优化，平衡编译速度和代码大小
- **-O2**：较高优化，代码大小和执行速度都较好
- **-O3**：最高优化，执行速度最快，但代码可能较大
- **-Os**：优化代码大小，适合资源受限的单片机

### 调试选项

- **-g**：生成调试信息
- **-g3**：生成更详细的调试信息
- **-ggdb**：生成适合GDB的调试信息

### 警告选项

- **-Wall**：启用所有警告
- **-Wextra**：启用额外警告
- **-Werror**：将警告视为错误
- **-Wpedantic**：严格遵循C标准

## 链接脚本规范

### ARM Cortex-M系列链接脚本规范

- **内存布局**：定义FLASH和RAM的起始地址和大小
- **代码段**：包含中断向量表、代码和只读数据
- **数据段**：包含初始化数据，从FLASH加载到RAM
- **BSS段**：包含未初始化数据
- **堆段**：定义堆的大小和位置
- **链接符号**：定义内存边界和特殊位置的符号

### 8051系列链接脚本规范

- **内存布局**：定义CODE、DATA和XDATA的空间
- **代码段**：包含程序代码和只读数据
- **数据段**：包含内部RAM数据
- **扩展数据段**：包含外部RAM数据
```

## 烧录工具

### STC系列烧录

#### STC-ISP工具

1. **功能**：STC官方烧录工具
2. **支持平台**：Windows
3. **使用方法**：
   - 打开STC-ISP软件
   - 选择目标单片机型号
   - 选择编译生成的.hex文件
   - 选择正确的串口
   - 点击"下载/编程"按钮
   - 给单片机上电

#### 命令行烧录工具

```bash
# stcflash工具
stcflash -p COM3 -b 115200 app.hex
```

### ARM Cortex-M系列烧录

#### ST-Link

1. **功能**：ST官方调试烧录工具
2. **支持平台**：STM32系列
3. **使用方法**：
   - 连接ST-Link到目标板
   - 使用STM32CubeProgrammer软件
   - 选择ST-Link作为调试器
   - 选择编译生成的.hex或.bin文件
   - 点击"Download"按钮

#### J-Link

1. **功能**：Segger公司的调试烧录工具
2. **支持平台**：多种ARM Cortex-M系列
3. **使用方法**：
   - 连接J-Link到目标板
   - 使用J-Flash软件
   - 选择目标设备
   - 选择编译生成的.hex或.bin文件
   - 点击"Program"按钮

#### OpenOCD

1. **功能**：开源调试烧录工具
2. **支持平台**：多种ARM Cortex-M系列
3. **使用方法**：
   ```bash
   # 烧录命令
   openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg -c "program app.hex verify reset exit"
   ```

### GD32系列烧录

#### GD-Link

1. **功能**：GD官方调试烧录工具
2. **支持平台**：GD32系列
3. **使用方法**：
   - 连接GD-Link到目标板
   - 使用GD32CubeProgrammer软件
   - 选择GD-Link作为调试器
   - 选择编译生成的.hex或.bin文件
   - 点击"Download"按钮

### HC32系列烧录

#### HC-Link

1. **功能**：HC官方调试烧录工具
2. **支持平台**：HC32系列
3. **使用方法**：
   - 连接HC-Link到目标板
   - 使用HC32FlashProgrammer软件
   - 选择目标设备
   - 选择编译生成的.hex或.bin文件
   - 点击"Program"按钮

### MM32系列烧录

#### MM-Link

1. **功能**：MM官方调试烧录工具
2. **支持平台**：MM32系列
3. **使用方法**：
   - 连接MM-Link到目标板
   - 使用MM32FlashProgrammer软件
   - 选择目标设备
   - 选择编译生成的.hex或.bin文件
   - 点击"Program"按钮

## 烧录脚本规范

### 通用烧录脚本规范

- **参数检查**：检查输入参数的有效性
- **平台选择**：根据平台选择合适的烧录工具和命令
- **烧录命令**：使用正确的烧录命令和参数
- **错误处理**：处理烧录过程中的错误
- **状态反馈**：提供清晰的烧录状态反馈

### 烧录流程规范

1. **连接设备**：确保设备正确连接
2. **擦除闪存**：根据需要擦除设备闪存
3. **写入固件**：将固件写入设备
4. **验证固件**：验证写入的固件是否正确
5. **重置设备**：烧录完成后重置设备
6. **状态报告**：报告烧录结果

## 构建流程

### 基本构建流程

1. **配置环境**：安装编译器和必要的工具
2. **编写代码**：按照代码规范编写源代码
3. **配置Makefile**：根据目标平台配置构建参数
4. **编译**：运行make命令编译代码
5. **检查**：检查编译结果和警告信息
6. **烧录**：将编译生成的固件烧录到目标设备
7. **测试**：运行测试验证功能

### 自动化构建流程

1. **版本控制**：使用Git管理代码
2. **持续集成**：使用CI/CD工具自动构建
3. **自动测试**：运行自动化测试
4. **固件发布**：生成发布版本的固件

## 常见问题

### 编译错误

1. **头文件找不到**：检查包含路径和头文件名称
2. **未定义的引用**：检查函数声明和链接顺序
3. **类型不匹配**：检查变量类型和函数参数
4. **语法错误**：检查代码语法和括号匹配

### 烧录错误

1. **连接失败**：检查硬件连接和驱动安装
2. **校验失败**：检查固件文件和烧录工具设置
3. **超时错误**：检查目标设备电源和复位电路
4. **权限错误**：检查串口权限或调试器权限

### 运行错误

1. **程序崩溃**：检查内存使用和指针操作
2. **功能异常**：检查代码逻辑和硬件连接
3. **性能问题**：检查算法和代码优化
4. **功耗问题**：检查电源管理和休眠模式

## 最佳实践

1. **使用版本控制**：使用Git管理代码和构建配置
2. **自动化构建**：使用Makefile或其他构建系统
3. **持续集成**：设置CI/CD流程自动构建和测试
4. **固件管理**：建立固件版本管理和发布流程
5. **烧录自动化**：编写烧录脚本简化烧录过程
6. **错误处理**：完善错误处理和日志记录
7. **性能优化**：根据目标平台进行合理优化
8. **安全考虑**：保护固件安全，防止未授权访问